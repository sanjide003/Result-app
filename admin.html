<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sadaye Madeena 2k25 - Admin Panel (v4.9)</title> <!-- Version Updated -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #4f46e5; /* Indigo 600 */
            --primary-hover-color: #4338ca; /* Indigo 700 */
            --primary-focus-ring: #a5b4fc; /* Indigo 300 lighter ring */
            --danger-color: #dc2626; /* Red 600 */
            --danger-hover-color: #b91c1c; /* Red 700 */
            --danger-focus-ring: #fca5a5; /* Red 300 */
            --warning-color: #f59e0b; /* Amber 500 */
            --warning-hover-color: #d97706; /* Amber 600 */
            --warning-focus-ring: #fcd34d; /* Amber 300 */
            --success-color: #16a34a; /* Green 600 */
            --success-hover-color: #15803d; /* Green 700 */
            --success-focus-ring: #86efac; /* Green 300 */
            --secondary-color: #4b5563; /* Gray 600 */
            --secondary-hover-color: #374151; /* Gray 700 */
            --secondary-focus-ring: #9ca3af; /* Gray 400 */
            --light-color: #ffffff;
            --light-text-color: #374151; /* Gray 700 */
            --light-border-color: #d1d5db; /* Gray 300 */
            --light-hover-bg: #f9fafb; /* Gray 50 */
        }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; /* Gray 100 */ }

        /* Contained Button Styles - Rounded-lg */
        .btn { @apply inline-flex items-center justify-center px-5 py-2 border border-transparent rounded-lg shadow-sm font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-opacity-75 transition duration-150 ease-in-out; }
        .btn:hover:not(:disabled) { @apply shadow-md; }
        .btn:active:not(:disabled) { @apply shadow-inner; }
        .btn:disabled { @apply opacity-60 cursor-not-allowed bg-gray-400 border-gray-400 shadow-none; }
        .btn i:not(.password-toggle-icon) { @apply mr-2 -ml-1 h-5 w-5; }
        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); focus:ring: var(--primary-focus-ring); }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover-color); border-color: var(--primary-hover-color); }
        .btn-danger { background-color: var(--danger-color); border-color: var(--danger-color); focus:ring: var(--danger-focus-ring); }
        .btn-danger:hover:not(:disabled) { background-color: var(--danger-hover-color); border-color: var(--danger-hover-color); }
        .btn-secondary { background-color: var(--secondary-color); border-color: var(--secondary-color); focus:ring: var(--secondary-focus-ring); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--secondary-hover-color); border-color: var(--secondary-hover-color); }
        .btn-success { background-color: var(--success-color); border-color: var(--success-color); focus:ring: var(--success-focus-ring); }
        .btn-success:hover:not(:disabled) { background-color: var(--success-hover-color); border-color: var(--success-hover-color); }
        .btn-warning { background-color: var(--warning-color); border-color: var(--warning-color); focus:ring: var(--warning-focus-ring); color: white; }
        .btn-warning:hover:not(:disabled) { background-color: var(--warning-hover-color); border-color: var(--warning-hover-color); }
        .btn-light { background-color: var(--light-color); color: var(--light-text-color); border: 1px solid var(--light-border-color); focus:ring: var(--primary-focus-ring); box-shadow: none; }
        .btn-light:hover:not(:disabled) { background-color: var(--light-hover-bg); }
        .btn-sm { @apply px-4 py-1.5 text-sm rounded-md; }

        /* Icon Button Style - Rounded-full */
        .btn-icon { @apply inline-flex items-center justify-center p-1.5 rounded-full text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 hover:bg-gray-100 transition duration-150 ease-in-out; }
        .btn-icon:disabled { @apply opacity-50 cursor-not-allowed hover:bg-transparent hover:text-gray-400; }
        .btn-icon i { @apply h-4 w-4 pointer-events-none; }
        .btn-icon.danger:hover:not(:disabled) { @apply text-red-600 bg-red-50; focus:ring-red-500; }
        .btn-icon.warning:hover:not(:disabled) { @apply text-amber-600 bg-amber-50; focus:ring-amber-500; }
        .btn-icon.success:hover:not(:disabled) { @apply text-green-600 bg-green-50; focus:ring-green-500; }
        .btn-icon.secondary:hover:not(:disabled) { @apply text-gray-600 bg-gray-100; focus:ring-gray-500; }

        /* Form & Card Styles - Rounded-xl */
        .form-input, .form-select, .form-textarea { @apply block w-full px-4 py-2 border border-gray-300 rounded-xl bg-gray-50 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out shadow-sm text-sm; }
        .form-label { @apply block text-xs font-medium text-gray-600 mb-1 uppercase tracking-wider; }
        .card { @apply bg-white shadow-lg rounded-xl p-6 md:p-8; }
        .card-header { @apply text-lg font-semibold text-gray-700 mb-5 border-b pb-3 border-gray-200; }
        .password-wrapper { @apply relative; }
        .password-toggle-btn { @apply absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-gray-600 cursor-pointer focus:outline-none; }

        /* Instruction Box - Rounded-lg */
        .info-text { @apply bg-indigo-50 text-indigo-700 p-4 border border-indigo-200 rounded-lg text-sm mb-6 shadow-sm; }
        .info-text strong { @apply font-medium text-indigo-800; }

        /* Menu Overlay Styles - Rounded-xl */
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); z-index: 1001; display: none; justify-content: center; align-items: flex-start; padding-top: 60px; opacity: 0; transition: opacity 0.3s ease; }
        .menu-box { background: white; width: 90%; max-width: 300px; border-radius: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,0.2); padding: 15px; transform: translateY(-20px); opacity: 0; transition: all 0.3s ease-out; }
        .menu-box.open { transform: translateY(0); opacity: 1; }
        .menu-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid #e2e8f0; }
        .menu-header .header-title { font-weight: 600; font-size: 1em; color: #1e293b; text-transform: uppercase; letter-spacing: 0.05em; }
        .close-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #64748b; padding: 5px; line-height: 1;}
        .menu-link { display: flex; align-items: center; padding: 10px 15px; text-decoration: none; color: #334155; font-weight: 500; border-radius: 0.5rem; transition: background-color 0.2s, color 0.2s; font-size: 0.95em; margin-bottom: 4px; }
        .menu-link:hover { background-color: #f1f5f9; }
        .menu-link.active { background-color: var(--primary-color); color: white; font-weight: 600; }
        .menu-link i { @apply w-5 mr-3 text-center text-gray-500; }
        .menu-link.active i { @apply text-indigo-100; }

        /* Custom file input */
        .file-input-label { @apply btn btn-light text-sm rounded-lg; cursor: pointer; }
        .file-input-label i { @apply mr-2; }
        .file-input-filename { @apply text-sm text-gray-500 ml-4 inline-block align-middle; }

        /* Table/List Styles - Rounded-lg container */
        .table-container { @apply border border-gray-200 rounded-lg overflow-hidden shadow-sm bg-white; }
        .table-header { @apply grid gap-4 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 bg-gray-50/70; }
        .table-row { @apply grid gap-4 px-6 py-4 items-center border-b border-gray-200 bg-white hover:bg-gray-50/50 transition-colors duration-150 text-sm; }
        .table-row:last-child { @apply border-b-0; }
        .table-cell-primary { @apply font-medium text-gray-800 break-words; }
        .table-cell-secondary { @apply text-gray-500 block text-xs; }
        .table-cell-highlight { @apply text-indigo-600 font-medium; }
        .table-actions { @apply flex justify-end items-center gap-1; }
        .badge { @apply text-xs font-semibold uppercase tracking-wider px-2 py-0.5 rounded-full inline-block leading-none; }
        .badge-group { @apply bg-purple-100 text-purple-800; }
        .badge-individual { @apply bg-blue-100 text-blue-800; }
        .badge-general { @apply bg-green-100 text-green-800; }

        /* Team Edit - Simplified, remove toggle styles */
        /* .team-display-view .form-label { ... } */
        /* .team-display-value { ... } */
        /* .team-edit-view { ... } */


        /* Page title style */
        .page-title { @apply text-xl font-semibold text-gray-700 mb-6 pb-2 border-b border-gray-300; }

        /* Login page gradient */
        #login-page { background: linear-gradient(135deg, #e0e7ff 0%, #ede9fe 50%, #fce7f3 100%); }

         /* Responsive adjustments */
        @media (max-width: 768px) {
             .hide-md { @apply hidden md:block; }
             .hide-md-grid { @apply hidden md:grid; }
        }
        @media (max-width: 640px) {
            .btn { @apply px-4 py-2 text-sm; }
            .card { @apply p-4 rounded-lg; }
            .card-header { @apply text-base mb-4 pb-2; }
            .page-title { @apply text-lg mb-4 pb-1; }
            .table-header, .table-row { @apply px-4 py-3 text-xs grid-cols-2; }
            .table-actions { @apply col-span-1 mt-1 sm:mt-0 justify-start sm:justify-end; }
            .table-cell-primary { @apply text-sm; }
            .hide-sm { @apply hidden sm:block; }
            .hide-sm-grid { @apply hidden sm:grid; }
            .form-input, .form-select, .form-textarea { @apply rounded-lg; }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex items-center justify-center p-4">
         <div class="w-full max-w-sm space-y-6"> <div class="text-center"> <i class="fas fa-user-shield text-4xl text-indigo-600 mb-2"></i> <h1 class="text-2xl font-bold text-gray-800">Admin Panel</h1> <p class="text-sm text-gray-600">Sadaye Madeena 2k25</p> </div> <div class="card"> <h2 class="card-header text-center">Login</h2> <form id="login-form" class="space-y-4"> <div> <label for="login-email" class="form-label">Email</label> <input type="email" id="login-email" class="form-input" required placeholder="your@email.com"> </div> <div> <label for="login-password" class="form-label">Password</label> <div class="password-wrapper"> <input type="password" id="login-password" class="form-input pr-10" required placeholder="••••••••"> <button type="button" aria-label="Show password" class="password-toggle-btn"><i class="fas fa-eye password-toggle-icon"></i></button> </div> </div> <button type="submit" class="btn btn-primary w-full !mt-5"><i class="fas fa-sign-in-alt"></i>Login</button> </form> </div> <div class="card bg-gray-50/50"> <h2 class="card-header text-center"> Register New Admin <span class="block text-xs font-normal text-gray-500 mt-1">(First Use Only)</span> </h2> <form id="register-form" class="space-y-4"> <div> <label for="register-email" class="form-label">Email</label> <input type="email" id="register-email" class="form-input" required placeholder="newadmin@email.com"> </div> <div> <label for="register-password" class="form-label">Password</label> <div class="password-wrapper"> <input type="password" id="register-password" class="form-input pr-10" required placeholder="Choose a strong password"> <button type="button" aria-label="Show password" class="password-toggle-btn"><i class="fas fa-eye password-toggle-icon"></i></button> </div> </div> <button type="submit" class="btn btn-secondary w-full !mt-5"><i class="fas fa-user-plus"></i>Register</button> </form> </div> </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden min-h-screen">
        <!-- Menu Overlay -->
        <div id="admin-menu-overlay" class="menu-overlay">
             <div id="admin-menu-box" class="menu-box"> <div class="menu-header"> <span class="header-title">Admin Menu</span> <button id="admin-menu-close-btn" class="close-btn">&times;</button> </div> <a href="#dashboard" data-target="page-dashboard" class="menu-link active"><i class="fas fa-home fa-fw"></i>Home Page</a> <a href="#participants" data-target="page-participants" class="menu-link"><i class="fas fa-id-card fa-fw"></i>Participants</a> <a href="#programs" data-target="page-programs" class="menu-link"><i class="fas fa-calendar-alt fa-fw"></i>Programs</a> <a href="#teams" data-target="page-teams" class="menu-link"><i class="fas fa-users fa-fw"></i>Teams</a> <a href="#results" data-target="page-results" class="menu-link"><i class="fas fa-poll fa-fw"></i>Results</a> <div class="mt-5 border-t border-gray-200 pt-3"> <button id="logout-button" class="w-full btn btn-danger btn-sm"><i class="fas fa-sign-out-alt"></i>Logout</button> </div> </div>
        </div>

        <!-- Main Content -->
        <div id="main-content">
            <!-- Top Bar -->
             <header class="bg-white shadow sticky top-0 z-10"> <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"> <div class="flex justify-between items-center h-14"> <div class="flex items-center"> <button id="admin-menu-btn" aria-label="Open menu" class="text-gray-500 focus:outline-none focus:text-gray-700 mr-3 p-2 rounded-full hover:bg-gray-100 md:mr-4"> <i class="fas fa-bars text-lg"></i> </button> <h1 class="text-md md:text-lg font-semibold text-gray-800">Admin Panel</h1> </div> <div class="text-xs sm:text-sm text-gray-500 font-medium truncate" id="admin-email"></div> </div> </div> </header>

            <!-- Page Content Area -->
            <main class="p-4 md:p-6 lg:p-8 max-w-5xl mx-auto space-y-6">

                <!-- Home Page Settings -->
                <div id="page-dashboard" class="admin-page space-y-6">
                    <h1 class="page-title">Home Page Settings</h1> <div class="info-text"> <strong>നിർദ്ദേശം:</strong> വെബ്സൈറ്റിന്റെ പ്രധാന പേജിൽ കാണിക്കേണ്ട വിവരങ്ങൾ ഇവിടെ നൽകുക. </div> <form id="form-homepage" class="space-y-6"> <div class="card"> <h2 class="card-header">Header & Hero</h2> <!-- ... fields ... --> </div> <div class="card"> <h2 class="card-header">About Section</h2> <!-- ... fields ... --> </div> <div class="card"> <h2 class="card-header">Statistics</h2> <!-- ... fields ... --> </div> <div class="card"> <h2 class="card-header">Image Gallery</h2> <!-- ... fields ... --> </div> <div class="card"> <h2 class="card-header">Footer</h2> <!-- ... fields ... --> </div> <div class="flex justify-end pt-2"> <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i>Save All</button> </div> </form>
                </div>

                <!-- Participants -->
                <div id="page-participants" class="admin-page hidden space-y-6">
                    <h1 class="page-title">Manage Participants</h1> <div class="info-text"> <strong>നിർദ്ദേശം:</strong> മത്സരാർത്ഥികളെ ചേർക്കാം... </div> <div class="card"> <h2 class="card-header">Add by Team</h2> <form id="form-add-participants" class="space-y-4"> <div> <label for="participant-add-team" class="form-label">Team</label> <select id="participant-add-team" class="form-select" required> <option value="">-- Select --</option> </select> </div> <div> <label for="participant-add-names" class="form-label">Names (One per line)</label> <textarea id="participant-add-names" class="form-textarea" rows="6" required></textarea> </div> <div class="flex justify-end"> <button type="submit" id="add-participants-btn" class="btn btn-success"><i class="fas fa-plus"></i>Add Participants</button> </div> </form> <div id="add-log-container" class="mt-5 hidden"> <h3 class="font-medium text-sm text-gray-700 mb-2">Log:</h3> <pre id="add-log" class="bg-gray-800 text-white rounded-md p-3 max-h-40 overflow-y-auto text-xs"></pre> </div> </div> <div class="card"> <h2 class="card-header">Current Participants</h2> <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"> <select id="participant-team-filter" class="form-select"> <option value="">All Teams</option> </select> <input type="text" id="participant-search" class="form-input" placeholder="Search..."> </div> <div id="participant-list-container" class="table-container"> <div class="table-header" style="grid-template-columns: 1.5fr 1fr 1fr 100px;"> <span>Name</span> <span>Chest No</span> <span>Team</span> <span class="text-right">Actions</span> </div> <div id="participant-list-admin" class="max-h-[60vh] overflow-y-auto"> <div class="table-row"> <p id="participant-list-placeholder" class="text-gray-500 col-span-4 text-center py-5">Loading...</p> </div> </div> </div> <div class="mt-5 pt-5 border-t border-gray-200 flex flex-col sm:flex-row justify-between items-center gap-3"> <p class="text-sm text-gray-600">Displayed: <strong id="participant-count" class="text-base text-gray-900 font-semibold">0</strong></p> <button id="delete-all-participants-btn" class="btn btn-danger btn-sm w-full sm:w-auto"> <i class="fas fa-exclamation-triangle"></i> Delete All </button> </div> </div>
                </div>

                <!-- Programs & Categories -->
                <div id="page-programs" class="admin-page hidden space-y-6">
                    <h1 class="page-title">Manage Programs & Categories</h1>
                     <div class="info-text"> <strong>നിർദ്ദേശം:</strong> കാറ്റഗറികളും പ്രോഗ്രാമുകളും ചേർക്കുക/എഡിറ്റ് ചെയ്യുക. പ്രോഗ്രാമിന്റെ തരം (Individual/Group/General) തിരഞ്ഞെടുക്കുക. </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1">
                            <div class="card">
                                <h2 class="card-header">Manage Categories</h2>
                                <form id="form-add-category" class="mb-5 flex items-end gap-2">
                                    <div class="flex-grow"> <label for="category-name" class="form-label">New Category</label> <input type="text" id="category-name" class="form-input" placeholder="e.g., Junior" required> </div>
                                    <button type="submit" class="btn btn-success btn-sm flex-shrink-0"><i class="fas fa-plus"></i>Add</button>
                                </form>
                                <div>
                                    <h3 class="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wider">Existing Categories</h3>
                                    <div id="category-list-container" class="table-container">
                                        <div class="table-header" style="grid-template-columns: 1fr auto;"> <span>Name</span> <span class="text-right">Actions</span> </div>
                                        <div id="category-list" class="max-h-[40vh] overflow-y-auto">
                                            <div class="table-row"><p class="text-gray-500 col-span-2 text-center py-3">Loading...</p></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="lg:col-span-2">
                            <div class="card">
                                <h2 class="card-header">Add New Program</h2>
                                <form id="form-add-program" class="space-y-4">
                                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"> <div> <label for="program-name" class="form-label">Program Name</label> <input type="text" id="program-name" class="form-input" placeholder="e.g., പ്രസംഗം" required> </div> <div> <label for="program-category" class="form-label">Category</label> <select id="program-category" class="form-select" required> <option value="">Select Category</option> </select> </div> </div>
                                     <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 items-end"> <div> <label for="program-points-first" class="form-label">1st Pts</label> <input type="number" id="program-points-first" class="form-input" value="5" required> </div> <div> <label for="program-points-second" class="form-label">2nd Pts</label> <input type="number" id="program-points-second" class="form-input" value="3" required> </div> <div> <label for="program-points-third" class="form-label">3rd Pts</label> <input type="number" id="program-points-third" class="form-input" value="1" required> </div> <div> <label for="program-type" class="form-label">Type</label> <select id="program-type" class="form-select" required> <option value="individual">Individual</option> <option value="group">Group</option> <option value="general">General</option> </select> </div> </div>
                                     <div class="flex justify-end pt-2"> <button type="submit" class="btn btn-success"><i class="fas fa-plus"></i>Add Program</button> </div>
                                </form>
                            </div>
                             <div class="card mt-6">
                                 <h2 class="card-header">Existing Programs</h2>
                                 <div id="program-list-container" class="table-container">
                                     <div class="table-header" style="grid-template-columns: 1.5fr 1fr 0.8fr 100px;"> <span>Program (Category)</span> <span>Points</span> <span>Type</span> <span class="text-right">Actions</span> </div>
                                     <div id="program-list" class="max-h-[60vh] overflow-y-auto"> <div class="table-row"><p class="text-gray-500 col-span-4 text-center py-5">Loading...</p></div> </div>
                                 </div>
                             </div>
                        </div>
                    </div>
                </div>

                <!-- Manage Teams -->
                <div id="page-teams" class="admin-page hidden space-y-6">
                    <h1 class="page-title">Manage Teams</h1> <div class="info-text"> <strong>നിർദ്ദേശം:</strong> ടീമുകളെ ചേർക്കുക, എഡിറ്റ് ചെയ്യുക... </div>
                    <div class="card"> <h2 class="card-header">Add New Team</h2> <form id="form-add-team" class="space-y-4"> <div> <label for="team-name" class="form-label">Team Name</label> <input type="text" id="team-name" class="form-input" placeholder="e.g., BURAQ" required> </div> <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <div> <label for="team-leader" class="form-label">Leader</label> <input type="text" id="team-leader" class="form-input"> </div> <div> <label for="team-asst" class="form-label">Asst. Leader</label> <input type="text" id="team-asst" class="form-input"> </div> </div> <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <div> <label for="team-id-from" class="form-label">Chest No From</label> <input type="number" id="team-id-from" class="form-input" placeholder="e.g., 101" required> </div> <div> <label for="team-id-to" class="form-label">Chest No To</label> <input type="number" id="team-id-to" class="form-input" placeholder="e.g., 199" required> </div> </div> <div class="flex justify-end pt-2"> <button type="submit" class="btn btn-success"><i class="fas fa-plus"></i>Add Team</button> </div> </form> </div>
                    <div class="card"> <h2 class="card-header">Edit Existing Teams</h2> <div id="team-list-admin" class="space-y-5"> <div class="text-center py-5"><p class="text-gray-500">Loading...</p></div> </div> </div>
                </div>

                <!-- Publish Results -->
                 <div id="page-results" class="admin-page hidden space-y-6">
                    <h1 class="page-title">Publish & Update Results</h1> <div class="info-text"> <strong>നിർദ്ദേശം:</strong> കാറ്റഗറിയും പ്രോഗ്രാമും തിരഞ്ഞെടുക്കുക... </div> <div class="card"> <h2 class="card-header">Publish / Edit Result</h2> <form id="form-publish-result"> <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5"> <div> <label for="result-category" class="form-label">Category</label> <select id="result-category" class="form-select" required> <option value="">-- Select --</option> </select> </div> <div> <label for="result-program" class="form-label">Program</label> <select id="result-program" class="form-select" required disabled> <option value="">-- Select Category --</option> </select> </div> </div> <div class="space-y-3"> <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1 items-start"> <div> <label for="result-first" class="form-label">1st Place (ChestNo/Team)</label> <input type="text" id="result-first" class="form-input" placeholder="e.g., 101 or TEAM A"> </div> <div class="pt-1 md:pt-6"> <span id="name-first" class="text-xs font-medium text-indigo-700 block min-h-[1rem]"></span> </div> </div> <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1 items-start"> <div> <label for="result-second" class="form-label">2nd Place</label> <input type="text" id="result-second" class="form-input" placeholder="e.g., 202"> </div> <div class="pt-1 md:pt-6"> <span id="name-second" class="text-xs font-medium text-indigo-700 block min-h-[1rem]"></span> </div> </div> <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1 items-start"> <div> <label for="result-third" class="form-label">3rd Place</label> <input type="text" id="result-third" class="form-input" placeholder="e.g., 301, 305"> </div> <div class="pt-1 md:pt-6"> <span id="name-third" class="text-xs font-medium text-indigo-700 block min-h-[1rem]"></span> </div> </div> </div> <div class="flex justify-end mt-6"> <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i>Publish Result</button> </div> </form> </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Firebase SDK & Admin Logic -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, getDoc, getDocs, deleteDoc, collection, onSnapshot, query, writeBatch, updateDoc, where } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // Firebase Config & Init
        const firebaseConfig = { apiKey: "AIzaSyDBfnce5gtJhW9u1xwU2FVPQGx2KvG1vw8", authDomain: "result25.firebaseapp.com", projectId: "result25", storageBucket: "result25.firebasestorage.app", messagingSenderId: "1099340945335", appId: "1:1099340945335:web:4fdc63db6bf6b40a30ba32", measurementId: "G-S4BJW3N642" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        const finalFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        finalFirebaseConfig.projectId = appId;


        const app = initializeApp(finalFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- [JavaScript Logic - v4.9 - Full Fix] ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Admin script loaded (v4.9)");
            let allPrograms = {}; // Key: programId
            let allCategories = []; // Array of {id, name}
            let allParticipants = {}; // Key: chestNo
            let allTeamsAdmin = {}; // Key: teamId (doc id from Firestore)
            let listenersAttached = false; // Flag to ensure listeners are attached only once
            const d = document;

            // --- DOM Selections ---
            // (Ensure all elements exist)
            const loginPage=d.getElementById('login-page'), adminPanel=d.getElementById('admin-panel'), loginForm=d.getElementById('login-form'), registerForm=d.getElementById('register-form'), logoutButton=d.getElementById('logout-button'), adminEmail=d.getElementById('admin-email'), pages=d.querySelectorAll('.admin-page'), adminMenuOverlay=d.getElementById('admin-menu-overlay'), adminMenuBox=d.getElementById('admin-menu-box'), adminMenuBtn=d.getElementById('admin-menu-btn'), adminMenuCloseBtn=d.getElementById('admin-menu-close-btn'), navLinks=d.querySelectorAll('.menu-link');
            const participantAddForm = d.getElementById('form-add-participants'), participantAddTeam = d.getElementById('participant-add-team'), participantAddNames = d.getElementById('participant-add-names'), addLogContainer = d.getElementById('add-log-container'), addLog = d.getElementById('add-log'), participantCountEl=d.getElementById('participant-count'), deleteAllParticipantsBtn=d.getElementById('delete-all-participants-btn'), participantTeamFilter = d.getElementById('participant-team-filter'), participantSearch = d.getElementById('participant-search'), participantListAdmin = d.getElementById('participant-list-admin'), participantListContainer = d.getElementById('participant-list-container'), participantListPlaceholder = d.getElementById('participant-list-placeholder');
            const categoryForm=d.getElementById('form-add-category'), categoryInput=d.getElementById('category-name'), categoryList=d.getElementById('category-list'), categoryListContainer=d.getElementById('category-list-container');
            const programForm=d.getElementById('form-add-program'), programNameInput=d.getElementById('program-name'), programCategorySelect=d.getElementById('program-category'), programList=d.getElementById('program-list'), programListContainer=d.getElementById('program-list-container');
            const programPointsFirst = d.getElementById('program-points-first'), programPointsSecond = d.getElementById('program-points-second'), programPointsThird = d.getElementById('program-points-third');
            const programTypeSelect = d.getElementById('program-type');
            const resultForm=d.getElementById('form-publish-result'), resultCategorySelect=d.getElementById('result-category'), resultProgramSelect=d.getElementById('result-program'), resultInputs={'first':d.getElementById('result-first'), 'second':d.getElementById('result-second'), 'third':d.getElementById('result-third')}, nameSpans={'first':d.getElementById('name-first'), 'second':d.getElementById('name-second'), 'third':d.getElementById('name-third')};
            const teamForm=d.getElementById('form-add-team'), teamListAdmin=d.getElementById('team-list-admin');
            const homepageForm=d.getElementById('form-homepage'); // Form element needed

             // --- Helper: Get Homepage Fields ---
             function getHomepageFields() {
                const fields = {};
                 const fieldIds = ['header_title', 'logo_url', 'main_title', 'subtitle', 'about_title', 'about_subtitle', 'about', 'about_image_url', 'gallery', 'total_programs', 'total_participants', 'total_categories', 'total_teams', 'institution_name', 'copyright_text', 'social_instagram', 'social_youtube', 'social_facebook'];
                 fieldIds.forEach(id => {
                     fields[id] = d.getElementById(`homepage-${id.replace(/_/g, '-')}`); // Convert snake_case to kebab-case for ID
                 });
                 return fields;
             }
            const homepageFields = getHomepageFields(); // Get fields after DOM load

            // Helper function to disable/enable forms/buttons
            const toggleDisabled = (elementOrSelector, isDisabled) => { /* ... */ };

            // --- Navigation Logic ---
             function openAdminNav() { /* ... */ }
             function closeAdminNav() { /* ... */ }
             if(adminMenuBtn) adminMenuBtn.addEventListener('click', openAdminNav); else console.error("Admin menu button missing");
             if(adminMenuCloseBtn) adminMenuCloseBtn.addEventListener('click', closeAdminNav); else console.error("Admin menu close button missing");
             if(adminMenuOverlay) adminMenuOverlay.addEventListener('click', (e) => { if (e.target === adminMenuOverlay) { closeAdminNav(); } }); else console.error("Admin menu overlay missing");
             if (navLinks && navLinks.length > 0) { navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const targetId = link.getAttribute('data-target'); if(!targetId) return; pages.forEach(page => page.classList.add('hidden')); const targetPage = d.getElementById(targetId); if (targetPage) { targetPage.classList.remove('hidden'); console.log("Navigated to:", targetId); } else { console.error("Target page missing:", targetId); return; } navLinks.forEach(nav => nav.classList.remove('active')); link.classList.add('active'); closeAdminNav(); loadDataForPage(targetId); }); }); } else { console.error("Nav links missing!"); }

            async function loadDataForPage(pageId) { /* ... */ }

            // --- Authentication ---
            onAuthStateChanged(auth, async (user) => { /* ... (Ensure initial data load happens AFTER login) ... */ });
            if (loginForm) { const loginButton = loginForm.querySelector('button[type="submit"]'); loginForm.addEventListener('submit', async (e) => { e.preventDefault(); /* ... login logic ... */ }); } else { console.error("Login form missing!"); }
            if (registerForm) { const registerButton = registerForm.querySelector('button[type="submit"]'); registerForm.addEventListener('submit', async (e) => { e.preventDefault(); /* ... register logic ... */ }); } else { console.error("Register form missing!"); }
            if (logoutButton) { logoutButton.addEventListener('click', async () => { /* ... logout logic ... */ }); } else { console.error("Logout button missing!"); }
            // Make togglePasswordVisibility globally accessible
            window.togglePasswordVisibility = (inputId, button) => { const input = d.getElementById(inputId); const icon = button?.querySelector('i'); if (!input || !icon) return; input.type = (input.type === "password") ? "text" : "password"; icon.classList.toggle("fa-eye"); icon.classList.toggle("fa-eye-slash"); };


            // --- Event Listener Attachment Function ---
            function attachEventListeners() {
                if (listenersAttached) {
                     console.log("Listeners already attached.");
                     return; // Prevent attaching multiple times
                }
                 console.log("Attaching event listeners...");

                 // Homepage Form
                 if (homepageForm) { homepageForm.addEventListener('submit', handleHomepageSave); console.log("Homepage form listener attached."); }
                 else { console.error("Homepage form missing"); }

                 // Participant Add Form
                 if (participantAddForm) { participantAddForm.addEventListener('submit', handleAddParticipants); console.log("Participant add form listener attached."); }
                 else { console.error("Participant Add Form missing"); }

                 // Participant Filters
                 if (participantTeamFilter) participantTeamFilter.addEventListener('change', renderParticipantList); else console.error("Participant team filter missing");
                 if (participantSearch) participantSearch.addEventListener('input', renderParticipantList); else console.error("Participant search input missing");

                 // Delete All Participants Button
                 if (deleteAllParticipantsBtn) { deleteAllParticipantsBtn.addEventListener('click', handleDeleteAllParticipants); } else { console.error("Delete all participants button missing"); }

                 // Category Add Form
                 if (categoryForm) { categoryForm.addEventListener('submit', handleAddCategory); console.log("Category add form listener attached."); }
                 else { console.error("Category form missing"); }

                 // Program Add Form
                 if (programForm) { programForm.addEventListener('submit', handleAddProgram); console.log("Program add form listener attached."); }
                 else { console.error("Program form elements missing"); }

                 // Result Form related listeners
                 if (resultForm) { resultForm.addEventListener('submit', handlePublishResult); console.log("Result form listener attached."); } else { console.error("Result form missing"); }
                 if (resultCategorySelect) { resultCategorySelect.addEventListener('change', handleResultCategoryChange); } else { console.error("Result category select missing"); }
                 if (resultProgramSelect) { resultProgramSelect.addEventListener('change', handleResultProgramChange); } else { console.error("Result program select missing"); }
                 Object.keys(resultInputs).forEach(pos => { const input = resultInputs[pos]; if(input) { input.addEventListener('input', () => updateWinnerName(pos)); } else { console.error(`Result input ${pos} missing`); } });

                 // Team Add Form
                 if (teamForm) { teamForm.addEventListener('submit', handleAddTeam); console.log("Team add form listener attached."); }
                 else { console.error("Team form missing"); }

                 // Event Delegation Setup for lists
                 setupListActionDelegation();

                 listenersAttached = true; // Set flag
                 console.log("All static event listeners attached.");
            }

            // Function to setup event delegation listeners for lists
            function setupListActionDelegation() {
                 console.log("Setting up list action delegation...");
                 // Participant List Actions
                 if (participantListContainer) { participantListContainer.addEventListener('click', (e) => handleListAction(e, 'participant')); console.log("Participant list delegation attached."); }
                 else { console.error("Participant list container missing"); }
                 // Category List Actions
                 if (categoryListContainer) { categoryListContainer.addEventListener('click', (e) => handleListAction(e, 'category')); console.log("Category list delegation attached."); }
                 else { console.error("Category list container missing"); }
                 // Program List Actions
                 if (programListContainer) { programListContainer.addEventListener('click', (e) => handleListAction(e, 'program')); console.log("Program list delegation attached."); }
                 else { console.error("Program list container missing"); }
                 // Team List Actions
                 if (teamListAdmin) { // Team list itself acts as container
                     teamListAdmin.addEventListener('click', (e) => handleListAction(e, 'team'));
                     teamListAdmin.addEventListener('submit', (e) => { if (e.target.classList.contains('team-update-form')) { handleSaveTeamChanges(e); } });
                     console.log("Team list delegation attached.");
                 } else { console.error("Team list container missing"); }
            }

            // Generic handler for list actions (Edit/Delete/Cancel) using delegation
            function handleListAction(event, type) {
                const targetButton = event.target.closest('button');
                if (!targetButton) return;
                const id = targetButton.dataset.id || targetButton.closest('[data-id]')?.dataset.id || targetButton.closest('.team-card')?.dataset.teamId;

                console.log(`Action button clicked: Type=${type}, ID=${id}, Classes=${targetButton.className}`);

                // Allow team cancel without ID check initially
                if (!id && !(type === 'team' && targetButton.classList.contains('cancel-edit-team-btn'))) {
                    console.warn("Could not find ID for action:", type, targetButton);
                    return;
                }

                switch (type) {
                    case 'participant':
                        if (targetButton.classList.contains('edit-participant-btn')) {
                            const p = allParticipants[id]; if(p) editParticipant(id, p.name, p.team); else console.error("Ppt not found:", id);
                        } else if (targetButton.classList.contains('delete-participant-btn')) { deleteParticipant(id); }
                        break;
                    case 'category':
                        if (targetButton.classList.contains('edit-category-btn')) {
                             const cat = allCategories.find(c => c.id === id); if(cat) editCategory(id, cat.name); else console.error("Cat not found:", id);
                        } else if (targetButton.classList.contains('delete-category-btn')) { deleteCategory(id); }
                        break;
                    case 'program':
                        if (targetButton.classList.contains('edit-program-btn')) {
                             const prog = allPrograms[id]; if(prog) { editProgram(id, prog.name, prog.category, prog.points_first, prog.points_second, prog.points_third, prog.programType || 'individual'); } else { console.error("Prog not found:", id); }
                        } else if (targetButton.classList.contains('delete-program-btn')) { deleteProgram(id); }
                        break;
                    case 'team':
                         const card = targetButton.closest('.team-card'); if (!card) return;
                         if (targetButton.classList.contains('edit-team-btn')) { handleEditTeamClick(card); }
                         else if (targetButton.classList.contains('delete-team-btn')) { deleteTeam(id); } // ID is correct here
                         else if (targetButton.classList.contains('cancel-edit-team-btn')) { handleCancelEditTeamClick(card); }
                         break;
                }
            }


            // --- Participants Page Logic ---
             async function loadAllParticipants() { /* ... */ }
             function renderParticipantList() { /* ... */ }
             async function editParticipant(chestNo, currentName, currentTeam) { /* ... */ }
             async function deleteParticipant(chestNo) { /* ... */ }
             async function handleAddParticipants(e) { e.preventDefault(); /* ... participant add logic + toggleDisabled ... */ }
             async function deleteAllParticipants(promptUser = true) { /* ... */ }
             async function handleDeleteAllParticipants() { toggleDisabled(deleteAllParticipantsBtn, true); try { await deleteAllParticipants(true); } catch(err){ console.log("Deletion cancelled/failed"); } finally { toggleDisabled(deleteAllParticipantsBtn, false); } }


            // --- Programs & Categories Page Logic ---
             async function loadCategories() { /* ... */ }
             async function handleAddCategory(e) { e.preventDefault(); const name = categoryInput.value.trim(); if (!name) return; toggleDisabled(categoryForm, true); try { await addDoc(collection(db, `artifacts/${appId}/public/data/categories`), { name }); categoryInput.value = ''; await loadCategories(); } catch (error) { alert(`Error: ${error.message}`); } finally { toggleDisabled(categoryForm, false); } }
             async function deleteCategory(id) { /* ... */ }
             async function editCategory(id, currentName) { /* ... */ }
             async function loadPrograms() { /* ... */ }
             async function handleAddProgram(e) { e.preventDefault(); /* ... program add logic + toggleDisabled ... */ }
             async function deleteProgram(id) { /* ... */ }
             async function editProgram(id, currentName, currentCategory, p1, p2, p3, currentType) { /* ... */ }


            // --- Results Page Logic ---
             function updateWinnerName(position) { /* ... */ }
             function clearNamePreviews() { /* ... */ }
             async function loadCategoriesForResults() { /* ... */ }
             async function loadProgramsForResults(selectedCategory = null) { /* ... */ }
             function handleResultCategoryChange(e) { const selectedCategory = e.target.value; if(resultForm) resultForm.reset(); clearNamePreviews(); if(resultCategorySelect) resultCategorySelect.value = selectedCategory; loadProgramsForResults(selectedCategory); if(resultProgramSelect) resultProgramSelect.disabled = !selectedCategory; }
             async function handleResultProgramChange(e) { const programId = e.target.value; const programSelect = e.target; if(resultInputs.first) resultInputs.first.value = ''; if(resultInputs.second) resultInputs.second.value = ''; if(resultInputs.third) resultInputs.third.value = ''; clearNamePreviews(); if(programSelect) programSelect.value = programId; if (!programId) return; try { const docSnap = await getDoc(doc(db, `artifacts/${appId}/public/data/results`, programId)); if (docSnap.exists()) { const data = docSnap.data(); if(resultInputs.first) resultInputs.first.value = data.first ? data.first.map(w => w.chest).join(', ') : ''; if(resultInputs.second) resultInputs.second.value = data.second ? data.second.map(w => w.chest).join(', ') : ''; if(resultInputs.third) resultInputs.third.value = data.third ? data.third.map(w => w.chest).join(', ') : ''; updateWinnerName('first'); updateWinnerName('second'); updateWinnerName('third'); } } catch(error){ console.error("Error fetching result:", error);} }
             async function handlePublishResult(e) { e.preventDefault(); /* ... result publish logic + toggleDisabled ... */ }


            // --- Teams Page Logic ---
             async function loadTeamsForAdmin() { /* ... */ }
             function renderAdminTeamList() { /* ... */ }
             async function handleAddTeam(e) { e.preventDefault(); /* ... team add logic + toggleDisabled ... */ }
             async function handleSaveTeamChanges(event) { /* ... */ }
             async function deleteTeam(id) { /* ... */ };
             function handleEditTeamClick(card) { /* ... */ }
             function handleCancelEditTeamClick(card) { /* ... */ }
             async function updateParticipantTeamNames(oldName, newName) { /* ... */ }


            // --- Home Page Content (Admin) ---
             async function loadHomepageContent() { /* ... */ }
             async function handleHomepageSave(e) { e.preventDefault(); /* ... homepage save logic + toggleDisabled ... */ }


            console.log("Functions defined. Waiting for Auth state...");

        }); // End DOMContentLoaded
    </script>
</body>
</html>

