<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sadaye Madeena 2k25 - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #4f46e5; /* Indigo 600 */
            --primary-hover-color: #4338ca; /* Indigo 700 */
            --primary-focus-ring: #6366f1; /* Indigo 500 */
            --danger-color: #dc2626; /* Red 600 */
            --danger-hover-color: #b91c1c; /* Red 700 */
            --danger-focus-ring: #ef4444; /* Red 500 */
            --warning-color: #f59e0b; /* Amber 500 */
            --warning-hover-color: #d97706; /* Amber 600 */
            --warning-focus-ring: #fcd34d; /* Amber 300 */
            --success-color: #16a34a; /* Green 600 */
            --success-hover-color: #15803d; /* Green 700 */
            --success-focus-ring: #22c55e; /* Green 500 */
            --secondary-color: #4b5563; /* Gray 600 */
            --secondary-hover-color: #374151; /* Gray 700 */
            --secondary-focus-ring: #6b7280; /* Gray 500 */
            --light-color: #ffffff;
            --light-text-color: #374151; /* Gray 700 */
            --light-border-color: #d1d5db; /* Gray 300 */
            --light-hover-bg: #f9fafb; /* Gray 50 */
        }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; /* Gray 100 */ }

        /* Contained Button Styles */
        .btn {
            @apply inline-flex items-center justify-center px-5 py-2 border border-transparent rounded-md shadow-sm font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-opacity-75 transition duration-150 ease-in-out;
        }
        .btn:hover { @apply shadow-md; }
        .btn:active { @apply shadow-inner; }
        .btn i:not(.password-toggle-icon) { @apply mr-2 -ml-1 h-5 w-5; }
        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); focus:ring: var(--primary-focus-ring); }
        .btn-primary:hover { background-color: var(--primary-hover-color); border-color: var(--primary-hover-color); }
        .btn-danger { background-color: var(--danger-color); border-color: var(--danger-color); focus:ring: var(--danger-focus-ring); }
        .btn-danger:hover { background-color: var(--danger-hover-color); border-color: var(--danger-hover-color); }
        .btn-secondary { background-color: var(--secondary-color); border-color: var(--secondary-color); focus:ring: var(--secondary-focus-ring); }
        .btn-secondary:hover { background-color: var(--secondary-hover-color); border-color: var(--secondary-hover-color); }
        .btn-success { background-color: var(--success-color); border-color: var(--success-color); focus:ring: var(--success-focus-ring); }
        .btn-success:hover { background-color: var(--success-hover-color); border-color: var(--success-hover-color); }
        .btn-warning { background-color: var(--warning-color); border-color: var(--warning-color); focus:ring: var(--warning-focus-ring); color: white; }
        .btn-warning:hover { background-color: var(--warning-hover-color); border-color: var(--warning-hover-color); }
        .btn-light { background-color: var(--light-color); color: var(--light-text-color); border: 1px solid var(--light-border-color); focus:ring: var(--primary-focus-ring); box-shadow: none; }
        .btn-light:hover { background-color: var(--light-hover-bg); }
        .btn-sm { @apply px-4 py-1.5 text-sm rounded; }

        /* Icon Button Style */
        .btn-icon {
            @apply inline-flex items-center justify-center p-1.5 rounded text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 hover:bg-gray-100 transition duration-150 ease-in-out;
        }
        .btn-icon i { @apply h-4 w-4; }
        .btn-icon.danger:hover { @apply text-red-600 bg-red-50; focus:ring-red-500; }
        .btn-icon.warning:hover { @apply text-amber-600 bg-amber-50; focus:ring-amber-500; }

        /* Form & Card Styles */
        .form-input, .form-select, .form-textarea { @apply block w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out shadow-sm text-sm; }
        .form-label { @apply block text-xs font-medium text-gray-600 mb-1 uppercase tracking-wider; }
        .card { @apply bg-white shadow-md rounded-lg p-6 md:p-8; }
        .card-header { @apply text-lg font-semibold text-gray-700 mb-5 border-b pb-3 border-gray-200; }
        .password-wrapper { @apply relative; }
        .password-toggle-btn { @apply absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 cursor-pointer focus:outline-none; }

        /* Instruction Box */
        .info-text { @apply bg-indigo-50 text-indigo-700 p-4 border border-indigo-200 rounded-md text-sm mb-6 shadow-sm; }
        .info-text strong { @apply font-medium text-indigo-800; }

        /* Menu Overlay Styles */
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); z-index: 1001; display: none; justify-content: center; align-items: flex-start; padding-top: 60px; opacity: 0; transition: opacity 0.3s ease; }
        .menu-box { background: white; width: 90%; max-width: 300px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); padding: 15px; transform: translateY(-20px); opacity: 0; transition: all 0.3s ease-out; }
        .menu-box.open { transform: translateY(0); opacity: 1; }
        .menu-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid #e2e8f0; }
        .menu-header .header-title { font-weight: 600; font-size: 1em; color: #1e293b; text-transform: uppercase; letter-spacing: 0.05em; }
        .close-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #64748b; padding: 5px; line-height: 1;}
        .menu-link { display: flex; align-items: center; padding: 10px 15px; text-decoration: none; color: #334155; font-weight: 500; border-radius: 6px; transition: background-color 0.2s, color 0.2s; font-size: 0.95em; margin-bottom: 4px; }
        .menu-link:hover { background-color: #f1f5f9; }
        .menu-link.active { background-color: var(--primary-color); color: white; font-weight: 600; }
        .menu-link i { @apply w-5 mr-3 text-center text-gray-500; }
        .menu-link.active i { @apply text-indigo-100; }

        /* Custom file input */
        .file-input-label { @apply btn btn-light text-sm; cursor: pointer; }
        .file-input-label i { @apply mr-2; }
        .file-input-filename { @apply text-sm text-gray-500 ml-4 inline-block align-middle; }

        /* Table/List Styles */
        .table-container { @apply border border-gray-200 rounded-lg overflow-hidden shadow-sm bg-white; }
        .table-header { @apply grid gap-4 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 bg-gray-50/70; }
        .table-row { @apply grid gap-4 px-6 py-4 items-center border-b border-gray-200 bg-white hover:bg-gray-50/50 transition-colors duration-150 text-sm; }
        .table-row:last-child { @apply border-b-0; }
        .table-cell-primary { @apply font-medium text-gray-800 break-words; }
        .table-cell-secondary { @apply text-gray-500 block text-xs; }
        .table-cell-highlight { @apply text-indigo-600 font-medium; }
        .table-actions { @apply flex justify-end items-center gap-1; }
        .badge { @apply text-xs font-semibold uppercase tracking-wider px-2 py-0.5 rounded-full inline-block leading-none; }
        .badge-group { @apply bg-purple-100 text-purple-800; }
        .badge-individual { @apply bg-blue-100 text-blue-800; }
        .badge-general { @apply bg-green-100 text-green-800; }

        /* Page title style */
        .page-title { @apply text-xl font-semibold text-gray-700 mb-6 pb-2 border-b border-gray-300; }

        /* Login page gradient */
        #login-page { background: linear-gradient(135deg, #eef2ff 0%, #f5f3ff 50%, #fdf2f8 100%); }

         /* Responsive adjustments */
        @media (max-width: 768px) {
             .hide-md { @apply hidden md:block; }
             .hide-md-grid { @apply hidden md:grid; }
        }
        @media (max-width: 640px) {
            .btn { @apply px-4 py-2 text-sm; }
            .card { @apply p-4; }
            .card-header { @apply text-base mb-4 pb-2; }
            .page-title { @apply text-lg mb-4 pb-1; }
            .table-header, .table-row { @apply px-4 py-3 text-xs grid-cols-2; }
            .table-actions { @apply col-span-1 mt-1 sm:mt-0 justify-start sm:justify-end; }
            .table-cell-primary { @apply text-sm; }
            .hide-sm { @apply hidden sm:block; }
            .hide-sm-grid { @apply hidden sm:grid; }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-sm space-y-6">
             <div class="text-center"> <i class="fas fa-user-shield text-4xl text-indigo-600 mb-2"></i> <h1 class="text-2xl font-bold text-gray-800">Admin Panel</h1> <p class="text-sm text-gray-600">Sadaye Madeena 2k25</p> </div>
             <div class="card"> <h2 class="card-header text-center">Login</h2> <form id="login-form" class="space-y-4"> <div> <label for="login-email" class="form-label">Email</label> <input type="email" id="login-email" class="form-input" required placeholder="your@email.com"> </div> <div> <label for="login-password" class="form-label">Password</label> <div class="password-wrapper"> <input type="password" id="login-password" class="form-input pr-10" required placeholder="••••••••"> <button type="button" aria-label="Show password" class="password-toggle-btn" onclick="togglePasswordVisibility('login-password', this)"><i class="fas fa-eye password-toggle-icon"></i></button> </div> </div> <button type="submit" class="btn btn-primary w-full !mt-5"><i class="fas fa-sign-in-alt"></i>Login</button> </form> </div>
             <div class="card bg-gray-50/50"> <h2 class="card-header text-center"> Register New Admin <span class="block text-xs font-normal text-gray-500 mt-1">(First Use Only)</span> </h2> <form id="register-form" class="space-y-4"> <div> <label for="register-email" class="form-label">Email</label> <input type="email" id="register-email" class="form-input" required placeholder="newadmin@email.com"> </div> <div> <label for="register-password" class="form-label">Password</label> <div class="password-wrapper"> <input type="password" id="register-password" class="form-input pr-10" required placeholder="Choose a strong password"> <button type="button" aria-label="Show password" class="password-toggle-btn" onclick="togglePasswordVisibility('register-password', this)"><i class="fas fa-eye password-toggle-icon"></i></button> </div> </div> <button type="submit" class="btn btn-secondary w-full !mt-5"><i class="fas fa-user-plus"></i>Register</button> </form> </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden min-h-screen">
        <!-- Menu Overlay -->
        <div id="admin-menu-overlay" class="menu-overlay">
             <div id="admin-menu-box" class="menu-box">
                 <div class="menu-header"> <span class="header-title">Admin Menu</span> <button id="admin-menu-close-btn" class="close-btn">&times;</button> </div>
                 <a href="#dashboard" data-target="page-dashboard" class="menu-link active"><i class="fas fa-home fa-fw"></i>Home Page</a>
                 <a href="#participants" data-target="page-participants" class="menu-link"><i class="fas fa-id-card fa-fw"></i>Participants</a>
                 <a href="#programs" data-target="page-programs" class="menu-link"><i class="fas fa-calendar-alt fa-fw"></i>Programs</a>
                 <a href="#teams" data-target="page-teams" class="menu-link"><i class="fas fa-users fa-fw"></i>Teams</a>
                 <a href="#results" data-target="page-results" class="menu-link"><i class="fas fa-poll fa-fw"></i>Results</a>
                 <div class="mt-5 border-t border-gray-200 pt-3"> <button id="logout-button" class="w-full btn btn-danger btn-sm"><i class="fas fa-sign-out-alt"></i>Logout</button> </div>
             </div>
        </div>

        <!-- Main Content -->
        <div id="main-content">
            <!-- Top Bar -->
             <header class="bg-white shadow sticky top-0 z-10"> <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"> <div class="flex justify-between items-center h-14"> <div class="flex items-center"> <button id="admin-menu-btn" aria-label="Open menu" class="text-gray-500 focus:outline-none focus:text-gray-700 mr-3 p-2 rounded-full hover:bg-gray-100 md:mr-4"> <i class="fas fa-bars text-lg"></i> </button> <h1 class="text-md md:text-lg font-semibold text-gray-800">Admin Panel</h1> </div> <div class="text-xs sm:text-sm text-gray-500 font-medium truncate" id="admin-email"></div> </div> </div> </header>

            <!-- Page Content Area -->
            <main class="p-4 md:p-6 lg:p-8 max-w-5xl mx-auto space-y-6">

                <!-- Home Page Settings -->
                <div id="page-dashboard" class="admin-page space-y-6">
                    <!-- Home page content unchanged -->
                    <h1 class="page-title">Home Page Settings</h1> <div class="info-text"> <strong>നിർദ്ദേശം:</strong> വെബ്സൈറ്റിന്റെ പ്രധാന പേജിൽ... </div> <form id="form-homepage" class="space-y-6"> <div class="card"> <h2 class="card-header">Header & Hero</h2> <!-- ... fields ... --> </div> <div class="card"> <h2 class="card-header">About Section</h2> <!-- ... fields ... --> </div> <div class="card"> <h2 class="card-header">Statistics</h2> <!-- ... fields ... --> </div> <div class="card"> <h2 class="card-header">Image Gallery</h2> <!-- ... fields ... --> </div> <div class="card"> <h2 class="card-header">Footer</h2> <!-- ... fields ... --> </div> <div class="flex justify-end pt-2"> <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i>Save All</button> </div> </form>
                </div>

                <!-- Participants -->
                <div id="page-participants" class="admin-page hidden space-y-6">
                    <h1 class="page-title">Manage Participants</h1> <div class="info-text"> <strong>നിർദ്ദേശം:</strong> മത്സരാർത്ഥികളെ ചേർക്കാം... </div> <div class="card"> <h2 class="card-header">Add by Team</h2> <!-- ... form ... --> </div> <div class="card"> <h2 class="card-header">Current Participants</h2> <!-- ... filter/search ... --> <div class="table-container"> <div class="table-header" style="grid-template-columns: 1.5fr 1fr 1fr 100px;"> <span>Name</span> <span>Chest No</span> <span>Team</span> <span class="text-right">Actions</span> </div> <div id="participant-list-admin" class="max-h-[60vh] overflow-y-auto"> <!-- ... list items ... --> </div> </div> <div class="mt-5 pt-5 border-t border-gray-200 flex flex-col sm:flex-row justify-between items-center gap-3"> <!-- ... count & delete all ... --> </div> </div>
                </div>

                <!-- Programs & Categories -->
                <div id="page-programs" class="admin-page hidden space-y-6">
                    <h1 class="page-title">Manage Programs & Categories</h1>
                     <div class="info-text"> <strong>നിർദ്ദേശം:</strong> കാറ്റഗറികളും പ്രോഗ്രാമുകളും ചേർക്കുക/എഡിറ്റ് ചെയ്യുക. പ്രോഗ്രാമിന്റെ തരം (Individual/Group/General) തിരഞ്ഞെടുക്കുക. </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1">
                            <div class="card">
                                <h2 class="card-header">Manage Categories</h2>
                                <form id="form-add-category" class="mb-5 flex items-end gap-2">
                                    <div class="flex-grow"> <label for="category-name" class="form-label">New Category</label> <input type="text" id="category-name" class="form-input" placeholder="e.g., Junior" required> </div>
                                    <button type="submit" class="btn btn-success btn-sm flex-shrink-0"><i class="fas fa-plus"></i>Add</button>
                                </form>
                                <div>
                                    <h3 class="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wider">Existing Categories</h3>
                                    <div class="table-container">
                                        <div class="table-header" style="grid-template-columns: 1fr auto;"> <span>Name</span> <span class="text-right">Actions</span> </div>
                                        <div id="category-list" class="max-h-[40vh] overflow-y-auto">
                                            <div class="table-row"><p class="text-gray-500 col-span-2 text-center py-3">Loading...</p></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-2">
                            <div class="card">
                                <h2 class="card-header">Add New Program</h2>
                                <form id="form-add-program" class="space-y-4">
                                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div> <label for="program-name" class="form-label">Program Name</label> <input type="text" id="program-name" class="form-input" placeholder="e.g., പ്രസംഗം" required> </div>
                                        <div> <label for="program-category" class="form-label">Category</label> <select id="program-category" class="form-select" required> <option value="">Select Category</option> </select> </div>
                                    </div>
                                     <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 items-end">
                                        <div> <label for="program-points-first" class="form-label">1st Pts</label> <input type="number" id="program-points-first" class="form-input" value="5" required> </div>
                                        <div> <label for="program-points-second" class="form-label">2nd Pts</label> <input type="number" id="program-points-second" class="form-input" value="3" required> </div>
                                        <div> <label for="program-points-third" class="form-label">3rd Pts</label> <input type="number" id="program-points-third" class="form-input" value="1" required> </div>
                                        <div>
                                            <label for="program-type" class="form-label">Type</label>
                                            <select id="program-type" class="form-select" required>
                                                <option value="individual">Individual</option>
                                                <option value="group">Group</option>
                                                <option value="general">General</option>
                                            </select>
                                        </div>
                                    </div>
                                     <div class="flex justify-end pt-2"> <button type="submit" class="btn btn-success"><i class="fas fa-plus"></i>Add Program</button> </div>
                                </form>
                            </div>

                             <div class="card mt-6">
                                 <h2 class="card-header">Existing Programs</h2>
                                 <div class="table-container">
                                     <div class="table-header" style="grid-template-columns: 1.5fr 1fr 0.8fr 100px;">
                                        <span>Program (Category)</span>
                                        <span>Points</span>
                                        <span>Type</span>
                                        <span class="text-right">Actions</span>
                                    </div>
                                    <div id="program-list" class="max-h-[60vh] overflow-y-auto">
                                        <div class="table-row"><p class="text-gray-500 col-span-4 text-center py-5">Loading...</p></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Manage Teams -->
                <div id="page-teams" class="admin-page hidden space-y-6">
                     <h1 class="page-title">Manage Teams</h1> <div class="info-text"> <strong>നിർദ്ദേശം:</strong> ടീമുകളെ ചേർക്കുക, എഡിറ്റ് ചെയ്യുക... </div> <div class="card"> <h2 class="card-header">Add New Team</h2> <!-- ... form ... --> </div> <div class="card"> <h2 class="card-header">Edit Existing Teams</h2> <div id="team-list-admin" class="space-y-5"> <!-- ... list items ... --> </div> </div>
                </div>

                <!-- Publish Results -->
                 <div id="page-results" class="admin-page hidden space-y-6">
                    <h1 class="page-title">Publish & Update Results</h1> <div class="info-text"> <strong>നിർദ്ദേശം:</strong> കാറ്റഗറിയും പ്രോഗ്രാമും തിരഞ്ഞെടുക്കുക... </div> <div class="card"> <h2 class="card-header">Publish / Edit Result</h2> <!-- ... form ... --> </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Firebase SDK & Admin Logic -->
    <script type="module">
        // *** FIX: Correct Firebase Import URLs ***
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, getDoc, getDocs, deleteDoc, collection, onSnapshot, query, writeBatch, updateDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // Firebase Config & Init (Same as before)
        const firebaseConfig = { apiKey: "AIzaSyDBfnce5gtJhW9u1xwU2FVPQGx2KvG1vw8", authDomain: "result25.firebaseapp.com", projectId: "result25", storageBucket: "result25.firebasestorage.app", messagingSenderId: "1099340945335", appId: "1:1099340945335:web:4fdc63db6bf6b40a30ba32", measurementId: "G-S4BJW3N642" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        const finalFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        finalFirebaseConfig.projectId = appId;


        const app = initializeApp(finalFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- [JavaScript Logic - Updated for Program Type] ---
        document.addEventListener('DOMContentLoaded', () => {
            let allPrograms = {};
            let allCategories = [];
            let allParticipants = {};
            let allTeamsAdmin = {};
            const d = document;

            // --- DOM Selections (Added programTypeSelect) ---
            const loginPage=d.getElementById('login-page'), adminPanel=d.getElementById('admin-panel'), loginForm=d.getElementById('login-form'), registerForm=d.getElementById('register-form'), logoutButton=d.getElementById('logout-button'), adminEmail=d.getElementById('admin-email'), pages=d.querySelectorAll('.admin-page'), adminMenuOverlay=d.getElementById('admin-menu-overlay'), adminMenuBox=d.getElementById('admin-menu-box'), adminMenuBtn=d.getElementById('admin-menu-btn'), adminMenuCloseBtn=d.getElementById('admin-menu-close-btn'), navLinks=d.querySelectorAll('.menu-link');
            const participantAddForm = d.getElementById('form-add-participants'), participantAddTeam = d.getElementById('participant-add-team'), participantAddNames = d.getElementById('participant-add-names'), addLogContainer = d.getElementById('add-log-container'), addLog = d.getElementById('add-log'), participantCountEl=d.getElementById('participant-count'), deleteAllParticipantsBtn=d.getElementById('delete-all-participants-btn'), participantTeamFilter = d.getElementById('participant-team-filter'), participantSearch = d.getElementById('participant-search'), participantListAdmin = d.getElementById('participant-list-admin'), participantListPlaceholder = d.getElementById('participant-list-placeholder');
            const categoryForm=d.getElementById('form-add-category'), categoryInput=d.getElementById('category-name'), categoryList=d.getElementById('category-list'), programForm=d.getElementById('form-add-program'), programNameInput=d.getElementById('program-name'), programCategorySelect=d.getElementById('program-category'), programList=d.getElementById('program-list'), programPointsFirst = d.getElementById('program-points-first'), programPointsSecond = d.getElementById('program-points-second'), programPointsThird = d.getElementById('program-points-third');
            const programTypeSelect = d.getElementById('program-type');
            const resultForm=d.getElementById('form-publish-result'), resultCategorySelect=d.getElementById('result-category'), resultProgramSelect=d.getElementById('result-program'), resultInputs={'first':d.getElementById('result-first'), 'second':d.getElementById('result-second'), 'third':d.getElementById('result-third')}, nameSpans={'first':d.getElementById('name-first'), 'second':d.getElementById('name-second'), 'third':d.getElementById('name-third')};
            const teamForm=d.getElementById('form-add-team'), teamListAdmin=d.getElementById('team-list-admin');
            const homepageForm=d.getElementById('form-homepage'), homepageFields={'header_title':d.getElementById('homepage-header-title'), 'logo_url':d.getElementById('homepage-logo-url'), 'main_title':d.getElementById('homepage-main-title'), 'subtitle':d.getElementById('homepage-subtitle'), 'about_title':d.getElementById('homepage-about-title'), 'about_subtitle':d.getElementById('homepage-about-subtitle'), 'about':d.getElementById('homepage-about'), 'about_image_url':d.getElementById('homepage-about-image-url'), 'gallery':d.getElementById('homepage-gallery'), 'total_programs':d.getElementById('homepage-total-programs'), 'total_participants':d.getElementById('homepage-total-participants'), 'total_categories':d.getElementById('homepage-total-categories'), 'total_teams':d.getElementById('homepage-total-teams'), 'institution_name':d.getElementById('homepage-institution-name'), 'copyright_text':d.getElementById('homepage-copyright-text'), 'social_instagram':d.getElementById('homepage-social-instagram'), 'social_youtube':d.getElementById('homepage-social-youtube'), 'social_facebook':d.getElementById('homepage-social-facebook')};

            // --- Navigation & Auth (Unchanged) ---
            function openAdminNav() { if(adminMenuOverlay && adminMenuBox) { adminMenuOverlay.style.display = 'flex'; setTimeout(() => { adminMenuOverlay.style.opacity = '1'; adminMenuBox.classList.add('open'); }, 10); } }
            function closeAdminNav() { if(adminMenuOverlay && adminMenuBox) { adminMenuOverlay.style.opacity = '0'; adminMenuBox.classList.remove('open'); setTimeout(() => { adminMenuOverlay.style.display = 'none'; }, 300); } }
            if(adminMenuBtn) adminMenuBtn.addEventListener('click', openAdminNav);
            if(adminMenuCloseBtn) adminMenuCloseBtn.addEventListener('click', closeAdminNav);
            if(adminMenuOverlay) adminMenuOverlay.addEventListener('click', (e) => { if (e.target === adminMenuOverlay) { closeAdminNav(); } });
            navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const targetId = link.getAttribute('data-target'); pages.forEach(page => page.classList.add('hidden')); const targetPage = d.getElementById(targetId); if (targetPage) targetPage.classList.remove('hidden'); navLinks.forEach(nav => nav.classList.remove('active')); link.classList.add('active'); closeAdminNav(); setTimeout(() => loadDataForPage(targetId), 50); }); }); // Added small delay
            function loadDataForPage(pageId) { console.log("Loading data for:", pageId); if (pageId === 'page-dashboard') loadHomepageContent(); if (pageId === 'page-participants') { loadTeamsForAdmin(); loadAllParticipants(); } if (pageId === 'page-programs') { loadCategories(); loadPrograms(); } if (pageId === 'page-results') { loadCategoriesForResults(); loadPrograms(); loadAllParticipants(); loadTeamsForAdmin(); } if (pageId === 'page-teams') loadTeamsForAdmin(); }
            onAuthStateChanged(auth, (user) => { if (user) { if(loginPage) loginPage.style.display = 'none'; if(adminPanel) adminPanel.style.display = 'block'; if(adminEmail) adminEmail.textContent = user.email; const defaultPageId = 'page-dashboard'; pages.forEach(page => page.classList.add('hidden')); const defaultPageElement = d.getElementById(defaultPageId); if (defaultPageElement) defaultPageElement.classList.remove('hidden'); navLinks.forEach(nav => nav.classList.remove('active')); const defaultNavLink = d.querySelector(`.menu-link[data-target="${defaultPageId}"]`); if (defaultNavLink) defaultNavLink.classList.add('active'); setTimeout(() => { loadDataForPage(defaultPageId); loadAllParticipants(); loadTeamsForAdmin(); loadCategories(); loadPrograms(); }, 100); } else { if(loginPage) loginPage.style.display = 'flex'; if(adminPanel) adminPanel.style.display = 'none'; } });
            if(loginForm) { loginForm.addEventListener('submit', async (e) => { e.preventDefault(); const email = d.getElementById('login-email').value; const password = d.getElementById('login-password').value; if (!email || !password) { alert("Enter email and password."); return; } try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { console.error("Login Error:", error); alert(`Login Failed: ${error.code} - ${error.message}`); } }); } else { console.error("Login form missing!"); }
            if(registerForm) { registerForm.addEventListener('submit', async (e) => { e.preventDefault(); const email = d.getElementById('register-email').value; const password = d.getElementById('register-password').value; if (!email || !password) { alert("Enter email and password."); return; } try { await createUserWithEmailAndPassword(auth, email, password); alert('Admin registered! Please login.'); registerForm.reset(); } catch (error) { console.error("Registration Error:", error); alert(`Registration Failed: ${error.code} - ${error.message}`); } }); } else { console.error("Register form missing!"); }
            if(logoutButton) { logoutButton.addEventListener('click', async () => { try { await signOut(auth); } catch(error) { alert(`Logout Failed: ${error.message}`); } }); } else { console.error("Logout button missing!"); }
            window.togglePasswordVisibility = function(inputId, button) { const input = d.getElementById(inputId); const icon = button.querySelector('i'); if (!input || !icon) return; input.type = (input.type === "password") ? "text" : "password"; icon.classList.toggle("fa-eye"); icon.classList.toggle("fa-eye-slash"); }

            // --- Participants Page Logic (Unchanged) ---
            async function loadAllParticipants() { /* ... */ }
            function renderParticipantList() { /* ... (Uses new table styles) */ }
            window.editParticipant = async (chestNo, currentName, currentTeam) => { /* ... */ };
            window.deleteParticipant = async (chestNo) => { /* ... */ };
            if (participantAddForm) { /* ... Add multiple participants ... */ }
            async function deleteAllParticipants(promptUser = true) { /* ... */ }
            if(deleteAllParticipantsBtn) deleteAllParticipantsBtn.addEventListener('click', () => deleteAllParticipants(true));
            if (participantTeamFilter) participantTeamFilter.addEventListener('change', renderParticipantList);
            if (participantSearch) participantSearch.addEventListener('input', renderParticipantList);

            // --- Programs & Categories Page Logic (UPDATED) ---
            async function loadCategories() { /* Uses new table styles */ }
            if(categoryForm && categoryInput) categoryForm.addEventListener('submit', async (e) => { /* ... */ });
            window.deleteCategory = async (id) => { /* ... */ };
            window.editCategory = async (id, currentName) => { /* ... */ };

            async function loadPrograms() { /* Updated rendering for type */ try { const q = query(collection(db, `artifacts/${appId}/public/data/programs`)); const snapshot = await getDocs(q); allPrograms = {}; snapshot.docs.forEach(docSnap => { allPrograms[docSnap.id] = { id: docSnap.id, ...docSnap.data() }; }); const sortedPrograms = Object.values(allPrograms).sort((a,b)=>a.name.localeCompare(b.name)); if (programList) programList.innerHTML = ''; if (sortedPrograms.length === 0) { if (programList) programList.innerHTML = '<div class="table-row"><p class="text-gray-500 italic col-span-4 text-center py-5">No programs added yet.</p></div>'; } else { sortedPrograms.forEach(prog => { if (programList) { const typeText = prog.programType === 'group' ? 'Group' : (prog.programType === 'general' ? 'General' : 'Individual'); const typeClass = prog.programType === 'group' ? 'badge-group' : (prog.programType === 'general' ? 'badge-general' : 'badge-individual'); programList.innerHTML += ` <div class="table-row" style="grid-template-columns: 1.5fr 1fr 0.8fr 100px;"> <div class="table-cell"> <span class="table-cell-primary">${prog.name}</span> <span class="table-cell-secondary">${prog.category}</span> </div> <div class="table-cell table-cell-secondary"> ${prog.points_first || 0}, ${prog.points_second || 0}, ${prog.points_third || 0} </div> <div class="table-cell"> <span class="badge ${typeClass}">${typeText}</span> </div> <div class="table-actions"> <button class="btn-icon warning" onclick="editProgram('${prog.id}', \`${prog.name}\`, '${prog.category}', '${prog.points_first || 0}', '${prog.points_second || 0}', '${prog.points_third || 0}', '${prog.programType || 'individual'}')"><i class="fas fa-edit"></i></button> <button class="btn-icon danger" onclick="deleteProgram('${prog.id}')"><i class="fas fa-trash-alt"></i></button> </div> </div>`; } }); } } catch(error) { console.error("Error loading programs:", error); if (programList) programList.innerHTML = '<div class="table-row"><p class="text-red-500 col-span-4 text-center py-5">Error loading.</p></div>';} }

            // *** Updated Add Program Logic ***
            if(programForm && programNameInput && programCategorySelect && programTypeSelect) {
                programForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = programNameInput.value.trim();
                    const category = programCategorySelect.value;
                    const points_first = parseInt(programPointsFirst.value, 10);
                    const points_second = parseInt(programPointsSecond.value, 10);
                    const points_third = parseInt(programPointsThird.value, 10);
                    const programType = programTypeSelect.value;

                    if (!name || !category || !programType || isNaN(points_first) || isNaN(points_second) || isNaN(points_third)) {
                        alert('Please fill in all fields correctly.'); return;
                    }
                    try {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/programs`), {
                            name, category, points_first, points_second, points_third, programType
                        });
                        programForm.reset();
                        programTypeSelect.value = 'individual'; // Reset dropdown
                        await loadPrograms();
                    } catch (error) { alert(`Error: ${error.message}`); }
                });
            }

            window.deleteProgram = async (id) => { /* Unchanged */ };

            // *** Updated Edit Program Logic ***
            window.editProgram = async (id, currentName, currentCategory, p1, p2, p3, currentType) => {
                const newName = prompt("New program name:", currentName);
                let categoryOptions = allCategories.map((cat, index) => `${index + 1}: ${cat.name}`).join('\n');
                let categoryPromptMsg = `Enter number for new category (current: '${currentCategory}'):\n${categoryOptions}`;
                const categoryChoiceIndex = prompt(categoryPromptMsg);
                let newCategory = currentCategory;
                if (categoryChoiceIndex && !isNaN(categoryChoiceIndex)) { let index = parseInt(categoryChoiceIndex) - 1; if (index >= 0 && index < allCategories.length) { newCategory = allCategories[index].name; } else { alert("Invalid category number."); } }

                const newP1 = prompt("New 1st points:", p1);
                const newP2 = prompt("New 2nd points:", p2);
                const newP3 = prompt("New 3rd points:", p3);

                const typeOptions = "1: Individual\n2: Group\n3: General";
                const typePromptMsg = `Select new program type (current: ${currentType}):\n${typeOptions}`;
                const typeChoice = prompt(typePromptMsg);
                let newType = currentType;
                if (typeChoice === '1') newType = 'individual';
                else if (typeChoice === '2') newType = 'group';
                else if (typeChoice === '3') newType = 'general';
                else if (typeChoice !== null) alert("Invalid type choice. Keeping original.");

                const dataToUpdate = {
                    name: (newName && newName.trim() !== '') ? newName.trim() : currentName,
                    category: newCategory,
                    points_first: (newP1 && !isNaN(newP1)) ? parseInt(newP1, 10) : parseInt(p1, 10),
                    points_second: (newP2 && !isNaN(newP2)) ? parseInt(newP2, 10) : parseInt(p2, 10),
                    points_third: (newP3 && !isNaN(newP3)) ? parseInt(newP3, 10) : parseInt(p3, 10),
                    programType: newType
                };

                const hasChanged = dataToUpdate.name !== currentName || dataToUpdate.category !== currentCategory || dataToUpdate.points_first !== parseInt(p1, 10) || dataToUpdate.points_second !== parseInt(p2, 10) || dataToUpdate.points_third !== parseInt(p3, 10) || dataToUpdate.programType !== currentType;

                if (!hasChanged) { alert("No changes made."); return; }

                try {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/programs`, id), dataToUpdate);
                    alert('Program updated!');
                    allPrograms[id] = { ...allPrograms[id], ...dataToUpdate };
                    await loadPrograms();
                } catch (error) { alert(`Error: ${error.message}`); }
            };


            // --- Results Page Logic (Unchanged logic, uses updated data structures) ---
            function updateWinnerName(position) { /* ... */ }
            if(resultInputs.first) resultInputs.first.addEventListener('input', () => updateWinnerName('first'));
            if(resultInputs.second) resultInputs.second.addEventListener('input', () => updateWinnerName('second'));
            if(resultInputs.third) resultInputs.third.addEventListener('input', () => updateWinnerName('third'));
            function clearNamePreviews() { /* ... */ }
            async function loadCategoriesForResults() { /* ... */ }
            async function loadProgramsForResults(selectedCategory = null) { /* ... */ }
            if(resultCategorySelect) { resultCategorySelect.addEventListener('change', (e) => { /* ... */ }); }
            if(resultProgramSelect) { resultProgramSelect.addEventListener('change', async (e) => { /* ... */ }); }
            if(resultForm) { resultForm.addEventListener('submit', async (e) => { /* Uses updated mapToWinnerData, but core logic same */ }); }

            // --- Teams Page Logic (Admin - Updated rendering) ---
            async function loadTeamsForAdmin() { /* ... */ }
            function renderAdminTeamList() { /* Uses new table styles */ }
            if(teamForm) teamForm.addEventListener('submit', async (e) => { /* ... Add team unchanged ... */ });
            async function handleUpdateTeam(e) { /* ... Update team unchanged ... */ }
            window.deleteTeam = async (id) => { /* ... Delete team unchanged ... */ };

            // --- Home Page Content (Admin - Unchanged) ---
            async function loadHomepageContent() { /* ... */ }
            if(homepageForm) homepageForm.addEventListener('submit', async (e) => { /* ... */ });

        }); // End DOMContentLoaded
    </script>
</body>
</html>

